# 宝塔面板部署指南

本指南将详细介绍如何在宝塔面板环境下部署 Coze API 转换服务。

## 📋 部署前准备

### 服务器要求
- **操作系统**：CentOS 7+ / Ubuntu 18+ / Debian 9+
- **内存**：至少 2GB RAM
- **存储**：至少 20GB 可用空间
- **网络**：稳定的互联网连接

### 宝塔面板要求
- **宝塔面板版本**：7.0+
- **必需软件**：
  - Nginx 1.18+
  - MySQL 8.0+
  - Node.js 20+
  - PM2 管理器

## 🚀 详细部署步骤

### 第一步：安装宝塔面板

1. **安装宝塔面板**
```bash
# CentOS 安装命令
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh

# Ubuntu/Debian 安装命令
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

2. **登录宝塔面板**
   - 安装完成后记录面板地址、用户名和密码
   - 通过浏览器访问面板地址进行初始化设置

### 第二步：安装必需软件

1. **在宝塔面板软件商店安装以下软件：**
   - **Nginx** 1.18+ （Web 服务器）
   - **MySQL** 8.0+ （数据库）
   - **Node.js** 20+ （运行环境）
   - **PM2** 管理器 （进程管理）

2. **验证安装**
```bash
# SSH 连接服务器后执行
node -v    # 应显示 v20.x.x
npm -v     # 应显示 npm 版本
mysql --version  # 应显示 MySQL 8.0+
nginx -v   # 应显示 Nginx 版本
pm2 -v     # 应显示 PM2 版本
```

### 第三步：创建数据库

1. **在宝塔面板数据库管理中：**
   - 点击"添加数据库"
   - 数据库名：`coze_freeapi`
   - 用户名：`coze_user`（或自定义）
   - 密码：设置强密码
   - 字符集：`utf8mb4`

2. **导入数据库结构**
```bash
# 方法1：通过宝塔面板数据库管理界面导入 database/init.sql

# 方法2：通过命令行导入
mysql -u coze_user -p coze_freeapi < /www/wwwroot/coze-freeapi/database/init.sql
```

### 第四步：上传项目文件

1. **创建网站目录**
   - 在宝塔面板"网站"中添加站点
   - 域名：你的域名（如 api.example.com）
   - 根目录：`/www/wwwroot/coze-freeapi`

2. **上传项目文件**
```bash
# 方法1：使用 Git（推荐）
cd /www/wwwroot/coze-freeapi
git clone https://github.com/your-username/coze-freeapi.git .

# 方法2：通过宝塔面板文件管理器上传压缩包并解压

# 方法3：使用 FTP/SFTP 工具上传
```

3. **设置文件权限**
```bash
chown -R www:www /www/wwwroot/coze-freeapi
chmod -R 755 /www/wwwroot/coze-freeapi
```

### 第五步：配置环境变量

1. **创建 .env 文件**
```bash
cd /www/wwwroot/coze-freeapi
cp .env.example .env
```

2. **编辑 .env 文件**
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=coze_user
DB_PASSWORD=your_database_password
DB_NAME=coze_freeapi

# JWT 配置
JWT_SECRET=your_very_long_and_secure_jwt_secret_key_here_at_least_32_characters
JWT_EXPIRES_IN=7d

# 服务配置
PORT=3001
NODE_ENV=production

# Coze API 配置
COZE_API_BASE_URL=https://api.coze.cn
COZE_API_TIMEOUT=30000

# 日志配置
LOG_LEVEL=info
LOG_MAX_FILES=30
LOG_MAX_SIZE=10m
```

### 第六步：安装依赖和构建项目

```bash
cd /www/wwwroot/coze-freeapi

# 安装依赖
npm install --production

# 构建后端
npm run build:backend

# 构建前端
npm run build

# 创建必要目录
mkdir -p logs uploads
chown -R www:www logs uploads
```

### 第七步：配置 PM2 启动服务

1. **启动后端服务**
```bash
cd /www/wwwroot/coze-freeapi

# 使用 PM2 启动
pm2 start ecosystem.config.js --env production

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

2. **验证服务状态**
```bash
# 查看服务状态
pm2 list

# 查看日志
pm2 logs coze-freeapi

# 测试 API
curl http://localhost:3001/api/health
```

### 第八步：配置 Nginx

1. **在宝塔面板网站设置中：**
   - 点击你创建的网站
   - 进入"网站设置"

2. **配置反向代理**
   - 点击"反向代理"
   - 添加反向代理：
     - 代理名称：`api`
     - 目标URL：`http://127.0.0.1:3001`
     - 发送域名：`$host`

3. **配置静态文件**
   - 网站目录设置为：`/www/wwwroot/coze-freeapi/dist`
   - 默认文档：`index.html`

4. **自定义 Nginx 配置**
```nginx
# 在网站设置 -> 配置文件中添加以下配置

# API 代理
location /api/ {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 请求体大小限制
    client_max_body_size 10M;
}

# 前端路由处理
location / {
    try_files $uri $uri/ /index.html;
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}

# 静态文件缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 第九步：配置 SSL 证书

1. **在宝塔面板网站设置中：**
   - 点击"SSL"
   - 选择"Let's Encrypt" 免费证书
   - 或上传自己的证书文件

2. **强制 HTTPS**
   - 开启"强制HTTPS"选项

### 第十步：测试部署

1. **测试后端 API**
```bash
# 健康检查
curl https://your-domain.com/api/health

# 测试注册接口
curl -X POST https://your-domain.com/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","email":"test@example.com","password":"123456"}'
```

2. **测试前端页面**
   - 访问 `https://your-domain.com`
   - 检查页面是否正常加载
   - 测试登录注册功能

## 🔧 常用维护命令

### PM2 管理
```bash
# 查看服务状态
pm2 list

# 重启服务
pm2 restart coze-freeapi

# 停止服务
pm2 stop coze-freeapi

# 查看日志
pm2 logs coze-freeapi

# 清空日志
pm2 flush

# 监控面板
pm2 monit
```

### 数据库维护
```bash
# 备份数据库
mysqldump -u coze_user -p coze_freeapi > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u coze_user -p coze_freeapi < backup_20240101.sql
```

### 日志管理
```bash
# 查看应用日志
tail -f /www/wwwroot/coze-freeapi/logs/combined.log

# 查看错误日志
tail -f /www/wwwroot/coze-freeapi/logs/err.log

# 查看 Nginx 日志
tail -f /www/wwwlogs/your-domain.com.log
```

## 🛡️ 安全配置

### 1. 防火墙设置
```bash
# 在宝塔面板安全设置中：
# - 开放端口：80, 443, 22
# - 关闭不必要的端口
# - 设置 SSH 端口（建议修改默认22端口）
```

### 2. 数据库安全
- 修改 MySQL root 密码
- 创建专用数据库用户
- 限制数据库访问权限
- 定期备份数据库

### 3. 文件权限
```bash
# 设置正确的文件权限
chown -R www:www /www/wwwroot/coze-freeapi
chmod -R 755 /www/wwwroot/coze-freeapi
chmod 600 /www/wwwroot/coze-freeapi/.env
```

### 4. Nginx 安全
- 隐藏 Nginx 版本信息
- 配置安全头
- 限制请求大小
- 配置访问频率限制

## 🚨 故障排除

### 常见问题及解决方案

1. **服务启动失败**
```bash
# 检查端口占用
netstat -tlnp | grep 3001

# 检查 PM2 日志
pm2 logs coze-freeapi

# 检查环境变量
cat /www/wwwroot/coze-freeapi/.env
```

2. **数据库连接失败**
```bash
# 测试数据库连接
mysql -u coze_user -p -h localhost coze_freeapi

# 检查数据库服务状态
systemctl status mysql
```

3. **前端页面无法访问**
```bash
# 检查 Nginx 配置
nginx -t

# 重启 Nginx
systemctl restart nginx

# 检查网站目录权限
ls -la /www/wwwroot/coze-freeapi/
```

4. **API 请求失败**
```bash
# 检查反向代理配置
curl -I http://localhost:3001/api/health

# 检查防火墙设置
iptables -L

# 检查 SSL 证书
openssl s_client -connect your-domain.com:443
```

## 📊 性能优化

### 1. 数据库优化
```sql
-- 添加索引
ALTER TABLE users ADD INDEX idx_username (username);
ALTER TABLE tokens ADD INDEX idx_user_id (user_id);
ALTER TABLE workflows ADD INDEX idx_user_id (user_id);
ALTER TABLE workflow_logs ADD INDEX idx_workflow_id (workflow_id);
ALTER TABLE workflow_logs ADD INDEX idx_created_at (created_at);
```

### 2. Nginx 优化
```nginx
# 启用 gzip 压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_comp_level 6;

# 启用缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. PM2 优化
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'coze-freeapi',
    script: './dist/api/app.js',
    instances: 'max',  // 使用所有 CPU 核心
    exec_mode: 'cluster',
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
```

## 📈 监控和告警

### 1. 使用宝塔面板监控
- 系统资源监控
- 网站访问统计
- 数据库性能监控

### 2. PM2 监控
```bash
# 安装 PM2 监控
pm2 install pm2-server-monit

# 查看监控面板
pm2 monit
```

### 3. 日志监控
```bash
# 设置日志轮转
logrotate -d /etc/logrotate.d/coze-freeapi
```

## 🔄 更新部署

### 自动化更新脚本
```bash
#!/bin/bash
# update.sh

cd /www/wwwroot/coze-freeapi

# 备份当前版本
cp -r . ../coze-freeapi-backup-$(date +%Y%m%d-%H%M%S)

# 拉取最新代码
git pull origin main

# 安装依赖
npm install --production

# 构建项目
npm run build:backend
npm run build

# 重启服务
pm2 restart coze-freeapi

echo "更新完成！"
```

---

## 📞 技术支持

如果在部署过程中遇到问题，请：

1. 检查本指南的故障排除部分
2. 查看项目的 GitHub Issues
3. 联系技术支持

**祝您部署成功！** 🎉